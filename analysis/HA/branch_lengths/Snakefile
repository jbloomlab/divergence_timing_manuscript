"""
Pipeline for prepping HA sequences for `phydms`

SKH 20171212
"""
import glob
import os
# from Bio import SeqIO
# import re
# import random
# import os
# import pandas as pd
# import glob
# import scipy
# from pymodules.utils import *
# from collections import Counter

# Globals ---------------------------------------------------------------------

# Directories
ALIGNMENT_DIR = "../data/subsample/"
PREFERNCES_DIR = "../data/references/"

# Alignment IDs
ALIGNMENT_IDS = ["_".join(os.path.basename(x).split(".")[0].split("_")[1:]) for x in glob.glob("{0}/*.fasta".format(ALIGNMENT_DIR))]
SEEDS = [int(x.split("_")[-1]) for x in ALIGNMENT_IDS]
LEVELS = ["high", "intermediate", "low"]
# WSN_IDS = [x for x in ALIGNMENT_IDS if "WSN" in x]
# PERTH_IDS = [x for x in ALIGNMENT_IDS if "Perth" in x]
# HYBRID_IDS = [x for x in ALIGNMENT_IDS if "hybrid" in x]
# assert (len(WSN_IDS) + len(PERTH_IDS) + len(HYBRID_IDS)) == len(ALIGNMENT_IDS)
# print(WSN_IDS)

# Rules -----------------------------------------------------------------------

rule all:
    input:
        expand("phydms/Perth_{level}_{seed}_modelcomparison.md", level=LEVELS, seed=SEEDS),
        expand("phydms/WSN_{level}_{seed}_modelcomparison.md", level=LEVELS, seed=SEEDS),
        expand("phydms/hybrid_high_{seed}_modelcomparison.md", seed=SEEDS)

## Run `phydms_comprehensive` for each of the preference sets (next 3 rules)
rule run_phydms_Lee:
    """
    This rule runs `phydms_comprehensive` for the alignments aligned to Perth.
    """
    message: "Running `phydms_comprehensive` with Juhye's preferences."
    input:
        alignment = ALIGNMENT_DIR + "HA_Perth_{level}_{seed}.fasta"
    output:
        modelcomparison = "phydms/Perth_{level}_{seed}_modelcomparison.md"
    params:
        prefs = "{0}HA_Lee_prefs.csv".format(PREFERNCES_DIR),
        phydms_id = 'Perth_{level}_{seed}'
    shell:
        'phydms_comprehensive phydms/{params.phydms_id} {input.alignment} {params.prefs} --raxml raxml --gammaomega --randprefs'

rule run_phydms_Doud:
    """
    This rule runs `phydms_comprehensive` for the alignments aligned to WSN.
    """
    message: "Running `phydms_comprehensive` with Mike's preferences."
    input:
        alignment = ALIGNMENT_DIR + "HA_WSN_{level}_{seed}.fasta"
    output:
        modelcomparison = "phydms/WSN_{level}_{seed}_modelcomparison.md"
    params:
        prefs = "{0}HA_Doud_prefs.csv".format(PREFERNCES_DIR),
        phydms_id = 'WSN_{level}_{seed}'
    shell:
        'phydms_comprehensive phydms/{params.phydms_id} {input.alignment} {params.prefs} --raxml raxml --gammaomega --randprefs'

rule run_phydms_hybrid:
    """
    This rule runs `phydms_comprehensive` for the alignments aligned to the
    hybrid sequence.
    """
    message: "Running `phydms_comprehensive` with average preferences."
    input:
        alignment = ALIGNMENT_DIR + "HA_hybrid_high_{seed}.fasta"
    output:
        modelcomparison = "phydms/hybrid_high_{seed}_modelcomparison.md"
    params:
        prefs = "{0}HA_average_prefs.csv".format(PREFERNCES_DIR),
        phydms_id = 'hybrid_high_{seed}'
    shell:
        'phydms_comprehensive phydms/{params.phydms_id} {input.alignment} {params.prefs} --raxml raxml --gammaomega --randprefs'
